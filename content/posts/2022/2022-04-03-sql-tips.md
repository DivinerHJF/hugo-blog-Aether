---
title: "数仓 | 写出更好的 SQL 语句"
date: 2022-04-03T16:13:54+08:00
categories: [数据库漫游]
tags:
  - 技术
  - SQL
  - 经验之谈
---

🔈 注：本文大部分内容译自 Medium 用户 [@Taylor Brownlow](https://taylor-count.medium.com/) 的[《Take Your SQL from Good to Great》](https://towardsdatascience.com/take-your-sql-from-good-to-great-part-1-3ae61539e92a)系列文章。

> 相较于 Python、R 等编程语言，SQL 语法是很简单，但要精通亦需努力。

![sql-cover](https://image-host-1255524710.cos.ap-beijing.myqcloud.com/img/20220403162620.png "SQL is easy until you understand and master it.")

<!--more-->

## 01: 清晰语句执行顺序[^1]

![sql-执行顺序](https://image-host-1255524710.cos.ap-beijing.myqcloud.com/img/20220405001143.png "Photo by Julia Evans.")

[^1]: [SQL queries don't start with SELECT](https://jvns.ca/blog/2019/10/03/sql-queries-don-t-start-with-select/)

## 02: 用 CTE 辅助查询[^2]

[^2]: [Take Your SQL from Good to Great](https://towardsdatascience.com/take-your-sql-from-good-to-great-part-1-3ae61539e92a)

`WITH` 语句通常被称为通用表表达式（Common Table Expressions）或者 CTEs，作为一个辅助语句依附于主语句，`WITH` 语句和主语句都可以是 `SELECT`，`INSERT`，`UPDATE`，`DELETE` 中的任何一种语句。

### CTE 创建语法

> **使用方法:**
>
> - 在主查询之前声明
> - 在 FROM 语句中按名称引用，就像对待数据库中的其他表一样

```sql
WITH cte_name AS (
  CTE_query_definition)

/* 注：可以同时定义1个或多个cte，做法是用逗号','隔开，最后一个cte后不跟',' */
WITH cte_name1 AS (
  CTE_query_definition),
cte_name2 AS (
  CTE_query_definition)
     ...
Main query
```

### CTE 的优势

![CTE](https://miro.medium.com/max/1400/1*ubIJsMiJqZxRPEhMTKMjrw.png "Medium-@Taylor Brownlow: Subquery V.S. CTE")

1. **提升复杂查询的可阅读性、可维护性**  
   CTE 让我们以一种简单易懂的方式来构造查询，这不仅使我们在`编写查询`时更加自然，而且使其他任何需要尝试`解释查询`的人更加方便。
   - 编写语句时更加自然，将问题模块化拆解，更符合人类思考模式
   - 结果验证时更有逻辑，快速定位问题节点，避免去反复断点试探
   - 修改功能时更加快速，专注定位特定模块，无需牵一发而动全身
2. **仅执行一次，存储在内存中，可提高执行效率**  
   因为语句一经执行，会在查询进程中保持数据处于内存中，在需要反复调用的情景下，既方便进行复用，又大大节省了计算资源，使查询快速高效地完成。
3. **可引用其他的 CTE 并可自引用**  
   通用表生成之后和数据库中的表被统一对待，所以对普通表能做的操作，通用表也都可以实现，大大提高了 SQL 语句的生命力与灵活性。

### 延伸阅读

- CTE 官方文档：[PostgreSQL](https://www.postgresql.org/docs/9.1/queries-with.html), [BigQuery](https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#with_clause), [Snowflake](https://docs.snowflake.com/en/sql-reference/constructs/with.html), [Redshift](https://docs.aws.amazon.com/redshift/latest/dg/r_WITH_clause.html), [MySQL](https://dev.mysql.com/doc/refman/8.0/en/with.html)

## 03: 学会处理时间数据

## 04: 了解更多连接形式

## 05: 善于使用窗口函数

---

> **参考文献**
>
> - [Four SQL Best Practices Helped me in my SQL Interviews](https://medium.com/@Hong_Tang/four-sql-best-practices-helped-me-in-my-sql-interviews-68e686b6d28a)
